<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="C/C++,Socket API,Thread,Data structure" />










<meta name="description" content="Redis Redis is an open source (BSD licensed), in-memory data structure store, used as a database, cache and message broker. It supports data structures such as strings, hashes, lists, sets, sorted set">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="http://yoursite.com/2018/11/29/redis/index.html">
<meta property="og:site_name" content="GeRunZe">
<meta property="og:description" content="Redis Redis is an open source (BSD licensed), in-memory data structure store, used as a database, cache and message broker. It supports data structures such as strings, hashes, lists, sets, sorted set">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-12-01T07:42:25.793Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redis">
<meta name="twitter:description" content="Redis Redis is an open source (BSD licensed), in-memory data structure store, used as a database, cache and message broker. It supports data structures such as strings, hashes, lists, sets, sorted set">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/11/29/redis/"/>





  <title>Redis | GeRunZe</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">GeRunZe</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Stay hungry, stay foolish!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/29/redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GeRunZe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/headimage.JPG">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeRunZe">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Redis</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-29T23:53:11+08:00">
                2018-11-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  11
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><blockquote>
<p>Redis is an open source (BSD licensed), in-memory data structure store, used as a database, cache and message broker. It supports data structures such as strings, hashes, lists, sets, sorted sets with range queries, bitmaps, hyperloglogs, geospatial indexes with radius queries and streams. Redis has built-in replication, Lua scripting, LRU eviction, transactions and different levels of on-disk persistence, and provides high availability via Redis Sentinel and automatic partitioning with Redis Cluster. <strong>Cite from</strong><a href="https://redis.io/" target="_blank" rel="noopener">Redis official Website</a></p>
</blockquote>
<a id="more"></a>
<h2 id="Redis和Mysql区别"><a href="#Redis和Mysql区别" class="headerlink" title="Redis和Mysql区别"></a>Redis和Mysql区别</h2><h3 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h3><p>Mysql是关系型数据库，主要用于存放持久化数据，将数据存储在硬盘中，读取速度较慢。一般用于存储整个系统数据。</p>
<h3 id="Redis-1"><a href="#Redis-1" class="headerlink" title="Redis"></a>Redis</h3><p>Mysql是Key-Value数据库，数据存在内存中，读取速度很快，但由于内存空间比硬盘小很多，所以只能存放少部分数据。</p>
<h3 id="Redis-Mysql"><a href="#Redis-Mysql" class="headerlink" title="Redis+Mysql"></a>Redis+Mysql</h3><p>我们各取两者长处，我们用<strong>高速缓存+持久化数据</strong>的方式搭建服务器。我们利用Mysql保存所有的数据，用户请求数据首先查看Redis中是否存在数据，如果有直接返回；如果没有则查询Mysql，并将数据存到Redis中作为缓存，这样数据查询速度大大加快。</p>
<ul>
<li>DNS解析域名的思路和上述方法类似，首先请求缓存中是否存在，如果不存在则向上一级服务器请求，并将结果加入缓存</li>
</ul>
<h2 id="C语言操作Redis"><a href="#C语言操作Redis" class="headerlink" title="C语言操作Redis"></a>C语言操作Redis</h2><blockquote>
<p>Redis提供的C语言API目前<strong>只能在Linux下使用</strong>。使用方法和Mysql提供的API类似。</p>
</blockquote>
<p>下面给出我自己写的基于Redis和Socket的借书系统，功能暂时只能支持还书和借书，并且没有用到Redis+Mysql的方法，以后会慢慢完善.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hiredis/hiredis.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//---------------------------------------------------全局变量</span></span><br><span class="line"><span class="keyword">int</span> listenfd;<span class="comment">//监听套接字</span></span><br><span class="line"><span class="keyword">int</span> nowconnect=<span class="number">0</span>;<span class="comment">//当前连接人数</span></span><br><span class="line"><span class="keyword">int</span> socketfd[<span class="number">100</span>];<span class="comment">//连接队列</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxsize=<span class="number">100</span>;<span class="comment">//最大连接数</span></span><br><span class="line">redisContext* context;<span class="comment">//redis连接句柄</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span><span class="comment">//服务器信息</span></span><br><span class="line"><span class="comment">//---------------------------------------------------全局变量</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    listenfd=Socket(AF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line">    bzero(&amp;servaddr,<span class="keyword">sizeof</span>(servaddr));</span><br><span class="line">    servaddr.sin_family=AF_INET;</span><br><span class="line">    servaddr.sin_port=htons(<span class="number">6666</span>);</span><br><span class="line">    servaddr.sin_addr.s_addr=htonl(INADDR_ANY);</span><br><span class="line">    Bind(listenfd,(SA*)&amp;servaddr,<span class="keyword">sizeof</span>(servaddr));</span><br><span class="line">    Listen(listenfd,<span class="number">100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"server argument initialized successful!\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">redisconnect</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    context = redisConnect(<span class="string">"127.0.0.1"</span>, <span class="number">6379</span>);<span class="comment">//默认端口，本机redis-server服务开启</span></span><br><span class="line">    <span class="keyword">if</span>(context-&gt;err)</span><br><span class="line">    &#123;</span><br><span class="line">        redisFree(context);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"connect redisServer err:%s\n"</span>, context-&gt;errstr);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"connect redisServer success\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">borrow</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="keyword">char</span> query[<span class="number">20</span>];</span><br><span class="line">     bzero(&amp;query,<span class="keyword">sizeof</span>(query));</span><br><span class="line">     recv(fd,query,<span class="keyword">sizeof</span>(query),<span class="number">0</span>);</span><br><span class="line">     redisReply *reply = (redisReply *)redisCommand(context, <span class="string">"get %s"</span>,query);</span><br><span class="line">     <span class="comment">//printf("get value %s\n",reply-&gt;str);</span></span><br><span class="line">     <span class="keyword">if</span>(<span class="literal">NULL</span> == reply)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"command execute failure1\n"</span>);</span><br><span class="line">            redisFree(context);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">     <span class="keyword">if</span>(reply-&gt;type==REDIS_REPLY_NIL)</span><br><span class="line">     &#123;</span><br><span class="line">         freeReplyObject(reply);</span><br><span class="line">         <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span>(<span class="built_in">strcmp</span>(reply-&gt;str,<span class="string">"0"</span>)==<span class="number">0</span>)</span><br><span class="line">     &#123;</span><br><span class="line">         freeReplyObject(reply);</span><br><span class="line">         <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     redisCommand(context, <span class="string">"set %s %s"</span>,query,<span class="string">"0"</span>);</span><br><span class="line">     freeReplyObject(reply);</span><br><span class="line">     <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">giveback</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> query[<span class="number">20</span>];</span><br><span class="line">    bzero(&amp;query,<span class="keyword">sizeof</span>(query));</span><br><span class="line">    recv(fd,query,<span class="keyword">sizeof</span>(query),<span class="number">0</span>);</span><br><span class="line">    redisReply *reply = (redisReply *)redisCommand(context, <span class="string">"get %s"</span>,query);</span><br><span class="line">    <span class="comment">//printf("get value %s\n",reply-&gt;str);</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == reply)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"command execute failure1\n"</span>);</span><br><span class="line">        redisFree(context);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(reply-&gt;type==REDIS_REPLY_NIL)</span><br><span class="line">    &#123;</span><br><span class="line">        freeReplyObject(reply);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(reply-&gt;str,<span class="string">"1"</span>)==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        freeReplyObject(reply);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    redisCommand(context, <span class="string">"set %s %s"</span>,query,<span class="string">"1"</span>);</span><br><span class="line">    freeReplyObject(reply);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfunc</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd=(<span class="keyword">int</span>)arg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">char</span> query[<span class="number">10</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">        bzero(&amp;query,<span class="keyword">sizeof</span>(query));</span><br><span class="line">        <span class="keyword">if</span>(recv(fd,query,<span class="keyword">sizeof</span>(query),<span class="number">0</span>)&lt;=<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;maxsize;i++)</span><br><span class="line">                <span class="keyword">if</span>(fd==socketfd[i])</span><br><span class="line">                &#123;</span><br><span class="line">                    socketfd[i]=<span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"someone disconnected from server!\n"</span>);</span><br><span class="line">            nowconnect--;</span><br><span class="line">            Close(fd);</span><br><span class="line">            pthread_exit((<span class="keyword">void</span>*)<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(query,<span class="string">"borrow"</span>)==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> res=borrow(fd);</span><br><span class="line">            <span class="keyword">if</span>(res==<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[]=<span class="string">"操作失败!"</span>;</span><br><span class="line">                send(fd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(res==<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[]=<span class="string">"成功借书,请阅读完后尽快归还！"</span>;</span><br><span class="line">                send(fd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(res==<span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[]=<span class="string">"书库暂时没有这本书!"</span>;</span><br><span class="line">                send(fd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(res==<span class="number">3</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[]=<span class="string">"此书已被借走!"</span>;</span><br><span class="line">                send(fd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(query,<span class="string">"giveback"</span>)==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> res=giveback(fd);</span><br><span class="line">            <span class="keyword">if</span>(res==<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[]=<span class="string">"操作失败!"</span>;</span><br><span class="line">                send(fd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(res==<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[]=<span class="string">"书库里没有这本书,操作失败!"</span>;</span><br><span class="line">                send(fd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(res==<span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[]=<span class="string">"此书没有被借,操作失败!"</span>;</span><br><span class="line">                send(fd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(res==<span class="number">3</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[]=<span class="string">"还书成功,欢迎下次借书!"</span>;</span><br><span class="line">                send(fd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arg;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">service</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"the server has started!\n"</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">cliaddr</span>;</span></span><br><span class="line">        <span class="keyword">socklen_t</span> len=<span class="keyword">sizeof</span>(cliaddr);</span><br><span class="line">        <span class="keyword">int</span> fd=accept(listenfd,(SA*)&amp;cliaddr,&amp;len);</span><br><span class="line">        <span class="keyword">if</span>(fd==<span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"客户端连接出错！\n"</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        nowconnect++;</span><br><span class="line">        <span class="keyword">if</span>(nowconnect==maxsize)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span>* str=<span class="string">"当前连接数满了，请过会再连接!"</span>;</span><br><span class="line">            send(fd,str,<span class="built_in">strlen</span>(str),<span class="number">0</span>);</span><br><span class="line">            close(fd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;maxsize;i++)</span><br><span class="line">            <span class="keyword">if</span>(socketfd[i]==<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                socketfd[i]=fd;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"当前连接数:%d\n"</span>,nowconnect);</span><br><span class="line">                <span class="keyword">pthread_t</span> tid;</span><br><span class="line">                pthread_create(&amp;tid,<span class="literal">NULL</span>,userfunc,(<span class="keyword">void</span>*)fd);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    init();</span><br><span class="line">    redisconnect();</span><br><span class="line">    service();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="改进版"><a href="#改进版" class="headerlink" title="改进版"></a>改进版</h2><blockquote>
<p>利用其他课程实验的时间，实现了Redis+Mysql联合查询。只实现了borrow函数，giveback函数读者可以参考borrow函数自己实现。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hiredis/hiredis.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mysql.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//---------------------------------------------------全局变量</span></span><br><span class="line"><span class="keyword">int</span> listenfd;<span class="comment">//监听套接字</span></span><br><span class="line"><span class="keyword">int</span> nowconnect=<span class="number">0</span>;<span class="comment">//当前连接人数</span></span><br><span class="line"><span class="keyword">int</span> socketfd[<span class="number">100</span>];<span class="comment">//连接队列</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxsize=<span class="number">100</span>;<span class="comment">//最大连接数</span></span><br><span class="line">redisContext* context;<span class="comment">//redis连接句柄</span></span><br><span class="line">MYSQL* conn;</span><br><span class="line">MYSQL_RES* res;</span><br><span class="line">MYSQL_ROW row;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span><span class="comment">//服务器信息</span></span><br><span class="line"><span class="comment">//---------------------------------------------------全局变量</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    listenfd=Socket(AF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line">    bzero(&amp;servaddr,<span class="keyword">sizeof</span>(servaddr));</span><br><span class="line">    servaddr.sin_family=AF_INET;</span><br><span class="line">    servaddr.sin_port=htons(<span class="number">6666</span>);</span><br><span class="line">    servaddr.sin_addr.s_addr=htonl(INADDR_ANY);</span><br><span class="line">    Bind(listenfd,(SA*)&amp;servaddr,<span class="keyword">sizeof</span>(servaddr));</span><br><span class="line">    Listen(listenfd,<span class="number">100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Server argument initialized successful!\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">redisconnect</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    context = redisConnect(<span class="string">"127.0.0.1"</span>, <span class="number">6379</span>);<span class="comment">//默认端口，本机redis-server服务开启</span></span><br><span class="line">    <span class="keyword">if</span>(context-&gt;err)</span><br><span class="line">    &#123;</span><br><span class="line">        redisFree(context);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"connect redisServer err:%s\n"</span>, context-&gt;errstr);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Connect redisServer success!\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mysqlconnect</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    conn=mysql_init(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(mysql_real_connect(conn,<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"geliang8888"</span>,<span class="string">"book"</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">0</span>))</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Connect mysqlServer success!\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">borrow</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="keyword">char</span> query[<span class="number">20</span>];</span><br><span class="line">     <span class="keyword">char</span> temp[<span class="number">100</span>];</span><br><span class="line">     bzero(&amp;temp,<span class="keyword">sizeof</span>(temp));</span><br><span class="line">     bzero(&amp;query,<span class="keyword">sizeof</span>(query));</span><br><span class="line">     recv(fd,query,<span class="keyword">sizeof</span>(query),<span class="number">0</span>);</span><br><span class="line">     redisReply *reply = (redisReply *)redisCommand(context, <span class="string">"get %s"</span>,query);</span><br><span class="line">     <span class="comment">//printf("get value %s\n",reply-&gt;str);</span></span><br><span class="line">     <span class="keyword">if</span>(<span class="literal">NULL</span> == reply)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"redis command err:%s\n"</span>,context-&gt;errstr);</span><br><span class="line">            freeReplyObject(reply);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">     <span class="keyword">if</span>(reply-&gt;type==REDIS_REPLY_NIL)</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="built_in">sprintf</span>(temp,<span class="string">"select* from bookinfo where bookname='%s'"</span>,query);</span><br><span class="line">         mysql_query(conn,temp);</span><br><span class="line">         res=mysql_store_result(conn);</span><br><span class="line">         <span class="keyword">if</span>(res==<span class="literal">NULL</span>)</span><br><span class="line">         &#123;</span><br><span class="line">             <span class="built_in">printf</span>(<span class="string">"res is NULL\n"</span>);</span><br><span class="line">             freeReplyObject(reply);</span><br><span class="line">             <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">         &#123;</span><br><span class="line">             <span class="built_in">printf</span>(<span class="string">"query from mysql!\n"</span>);</span><br><span class="line">             row=mysql_fetch_row(res);</span><br><span class="line">             <span class="keyword">if</span>(row==<span class="literal">NULL</span>)</span><br><span class="line">             &#123;</span><br><span class="line">                 freeReplyObject(reply);</span><br><span class="line">                 <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">char</span>* bookname=row[<span class="number">0</span>];</span><br><span class="line">             <span class="keyword">char</span>* status=row[<span class="number">1</span>];</span><br><span class="line">             <span class="keyword">if</span>(<span class="built_in">strcmp</span>(status,<span class="string">"0"</span>)==<span class="number">0</span>)</span><br><span class="line">             &#123;</span><br><span class="line">                 redisCommand(context, <span class="string">"set %s %s"</span>,bookname,<span class="string">"0"</span>);</span><br><span class="line">                 redisCommand(context, <span class="string">"expire %s %s"</span>,bookname,<span class="string">"20"</span>);</span><br><span class="line">                 freeReplyObject(reply);</span><br><span class="line">                 <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             bzero(&amp;temp,<span class="keyword">sizeof</span>(temp));</span><br><span class="line">             <span class="built_in">sprintf</span>(temp,<span class="string">"update bookinfo set status='%s' where bookname='%s'"</span>,<span class="string">"0"</span>,bookname);</span><br><span class="line">             mysql_query(conn, temp);</span><br><span class="line">             redisCommand(context, <span class="string">"set %s %s"</span>,bookname,<span class="string">"0"</span>);</span><br><span class="line">             redisCommand(context, <span class="string">"expire %s %s"</span>,bookname,<span class="string">"20"</span>);</span><br><span class="line">             freeReplyObject(reply);</span><br><span class="line">             <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span>(<span class="built_in">strcmp</span>(reply-&gt;str,<span class="string">"0"</span>)==<span class="number">0</span>)</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">"query from redis!\n"</span>);</span><br><span class="line">         freeReplyObject(reply);</span><br><span class="line">         <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"query from redis!\n"</span>);</span><br><span class="line">     redisCommand(context, <span class="string">"set %s %s"</span>,query,<span class="string">"0"</span>);</span><br><span class="line">     redisCommand(context, <span class="string">"expire %s %s"</span>,query,<span class="string">"20"</span>);</span><br><span class="line">     bzero(&amp;temp,<span class="keyword">sizeof</span>(temp));</span><br><span class="line">     <span class="built_in">sprintf</span>(temp,<span class="string">"update bookinfo set status='%s' where bookname='%s"</span>,<span class="string">"0"</span>,query);</span><br><span class="line">     mysql_query(conn, temp);</span><br><span class="line">     freeReplyObject(reply);</span><br><span class="line">     <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">giveback</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> query[<span class="number">20</span>];</span><br><span class="line">    bzero(&amp;query,<span class="keyword">sizeof</span>(query));</span><br><span class="line">    recv(fd,query,<span class="keyword">sizeof</span>(query),<span class="number">0</span>);</span><br><span class="line">    redisReply *reply = (redisReply *)redisCommand(context, <span class="string">"get %s"</span>,query);</span><br><span class="line">    <span class="comment">//printf("get value %s\n",reply-&gt;str);</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == reply)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"command execute failure1\n"</span>);</span><br><span class="line">        redisFree(context);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(reply-&gt;type==REDIS_REPLY_NIL)</span><br><span class="line">    &#123;</span><br><span class="line">        freeReplyObject(reply);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(reply-&gt;str,<span class="string">"1"</span>)==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        freeReplyObject(reply);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    redisCommand(context, <span class="string">"set %s %s"</span>,query,<span class="string">"1"</span>);</span><br><span class="line">    redisCommand(context, <span class="string">"expire %s %s"</span>,query,<span class="string">"20"</span>);</span><br><span class="line">    freeReplyObject(reply);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfunc</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd=(<span class="keyword">int</span>)arg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">char</span> query[<span class="number">10</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">        bzero(&amp;query,<span class="keyword">sizeof</span>(query));</span><br><span class="line">        <span class="keyword">if</span>(recv(fd,query,<span class="keyword">sizeof</span>(query),<span class="number">0</span>)&lt;=<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;maxsize;i++)</span><br><span class="line">                <span class="keyword">if</span>(fd==socketfd[i])</span><br><span class="line">                &#123;</span><br><span class="line">                    socketfd[i]=<span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"someone disconnected from server!\n"</span>);</span><br><span class="line">            nowconnect--;</span><br><span class="line">            Close(fd);</span><br><span class="line">            pthread_exit((<span class="keyword">void</span>*)<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(query,<span class="string">"borrow"</span>)==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> res=borrow(fd);</span><br><span class="line">            <span class="keyword">if</span>(res==<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[]=<span class="string">"操作失败!"</span>;</span><br><span class="line">                send(fd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(res==<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[]=<span class="string">"成功借书,请阅读完后尽快归还！"</span>;</span><br><span class="line">                send(fd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(res==<span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[]=<span class="string">"书库暂时没有这本书!"</span>;</span><br><span class="line">                send(fd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(res==<span class="number">3</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[]=<span class="string">"此书已被借走!"</span>;</span><br><span class="line">                send(fd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(query,<span class="string">"giveback"</span>)==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> res=giveback(fd);</span><br><span class="line">            <span class="keyword">if</span>(res==<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[]=<span class="string">"操作失败!"</span>;</span><br><span class="line">                send(fd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(res==<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[]=<span class="string">"书库里没有这本书,操作失败!"</span>;</span><br><span class="line">                send(fd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(res==<span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[]=<span class="string">"此书没有被借,操作失败!"</span>;</span><br><span class="line">                send(fd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(res==<span class="number">3</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> buf[]=<span class="string">"还书成功,欢迎下次借书!"</span>;</span><br><span class="line">                send(fd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arg;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">service</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"The server has started!\n"</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">cliaddr</span>;</span></span><br><span class="line">        <span class="keyword">socklen_t</span> len=<span class="keyword">sizeof</span>(cliaddr);</span><br><span class="line">        <span class="keyword">int</span> fd=accept(listenfd,(SA*)&amp;cliaddr,&amp;len);</span><br><span class="line">        <span class="keyword">if</span>(fd==<span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"客户端连接出错！\n"</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        nowconnect++;</span><br><span class="line">        <span class="keyword">if</span>(nowconnect==maxsize)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span>* str=<span class="string">"当前连接数满了，请过会再连接!"</span>;</span><br><span class="line">            send(fd,str,<span class="built_in">strlen</span>(str),<span class="number">0</span>);</span><br><span class="line">            close(fd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;maxsize;i++)</span><br><span class="line">            <span class="keyword">if</span>(socketfd[i]==<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                socketfd[i]=fd;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"当前连接数:%d\n"</span>,nowconnect);</span><br><span class="line">                <span class="keyword">pthread_t</span> tid;</span><br><span class="line">                pthread_create(&amp;tid,<span class="literal">NULL</span>,userfunc,(<span class="keyword">void</span>*)fd);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    init();</span><br><span class="line">    mysqlconnect();</span><br><span class="line">    redisconnect();</span><br><span class="line">    service();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li><p>Redis的出现使查询数据的性能大大增加，和Mysql配合使用可以实现高并发服务器</p>
</li>
<li><p>Redis数据库让<strong>高速缓存+数据持久化</strong>的思想更好地实现</p>
</li>
<li><p>如果读者有兴趣，可以思考怎样在上面的代码中加入Mysql实现<strong>高速缓存+数据持久化</strong>的思想，我会将代码传到我的<a href="https://github.com/woshigerunze/Redis-Mysql" target="_blank" rel="noopener">GitHub</a></p>
</li>
</ul>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>Your support will encourage me to continue to update!</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat.JPG" alt="GeRunZe 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.JPG" alt="GeRunZe 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/25/leetcode5/" rel="next" title="LeetCode5.最长回文子串">
                <i class="fa fa-chevron-left"></i> LeetCode5.最长回文子串
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/12/06/leetcode946/" rel="prev" title="LeetCode946.验证栈序列">
                LeetCode946.验证栈序列 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/headimage.JPG"
                alt="GeRunZe" />
            
              <p class="site-author-name" itemprop="name">GeRunZe</p>
              <p class="site-description motion-element" itemprop="description">Challenger.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/woshigerunze" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:664279928@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Redis"><span class="nav-number">1.</span> <span class="nav-text">Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis和Mysql区别"><span class="nav-number">1.1.</span> <span class="nav-text">Redis和Mysql区别</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Mysql"><span class="nav-number">1.1.1.</span> <span class="nav-text">Mysql</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-1"><span class="nav-number">1.1.2.</span> <span class="nav-text">Redis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Mysql"><span class="nav-number">1.1.3.</span> <span class="nav-text">Redis+Mysql</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C语言操作Redis"><span class="nav-number">1.2.</span> <span class="nav-text">C语言操作Redis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#改进版"><span class="nav-number">1.3.</span> <span class="nav-text">改进版</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">1.4.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-GeRunZe"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">GeRunZe</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">18.3k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>



<div class="busuanzi-count">
  <script async="" src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  <span class="site-uv">
  <i class="fa fa-user"> 本站访客数</i>
  <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
  人
  </span>

  <span class="site-pv">
  <i class="fa fa-eye"> 本站总访问量</i>
  <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
  次
  </span>

</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
